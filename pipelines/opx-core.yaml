groups: #######################################################################

- name: commit
  jobs: [release-jessie, release-stretch]

- name: tag
  jobs: [promote-jessie, promote-stretch]

- name: review
  jobs: [check-jessie, check-stretch, pull-request-jessie, pull-request-stretch]

resource_types: ###############################################################

- name: gerrit
  type: docker-image
  source:
    repository: us.gcr.io/concourse-resources/gerrit-resource

- name: pull-request
  type: docker-image
  source:
    repository: jtarchie/pr

- name: aptly-resource
  type: docker-image
  source:
    repository: opxhub/aptly-resource

- name: email
  type: docker-image
  source:
    repository: pcfseceng/email-resource

resources: ####################################################################

## Source repositories ##

- name: opx-core
  type: git
  source:
    uri: https://github.com/open-switch/opx-core
    branch: master

- name: opx-core-tag
  type: git
  source:
    uri: https://github.com/open-switch/opx-core
    branch: master
    tag_filter: "debian/*"

- name: opx-core-pr
  type: pull-request
  source:
    access_token: ((github-pr))
    repo: open-switch/opx-core

## CI configuration ##

- name: concourse
  type: git
  source:
    uri: https://github.com/open-switch/continuous-integration
    branch: master

- name: review-opx-core
  type: gerrit
  source:
    url: https://review.openswitch.net
    username: ((gerrit.username))
    password: ((gerrit.password))
    digest_auth: true
    query: "status:open project:opx/opx-core"

- name: aptly
  type: aptly-resource
  source:
    api: http://aptly:8080/api

- name: email
  type: email
  source:
    smtp:
      host: email-smtp.us-west-2.amazonaws.com
      port: "587"
      username: ((smtp.username))
      password: ((smtp.password))
    from: opx@openswitch.net
    to:
    -  tyler.heucke@dell.com

jobs: #########################################################################

## On commit ##

- name: release-jessie
  public: true
  plan:
  - aggregate:
    - get: opx-core
      trigger: true
    - get: concourse
  - task: bump-version
    file: concourse/tasks/debchange-simple/task.yaml
    input_mapping:
      src: opx-core
    output_mapping:
      src-artifacts: opx-core-bumped
  - task: build
    file: concourse/tasks/dpkg-deb-jessie/task.yaml
    input_mapping:
      src: opx-core-bumped
    output_mapping:
      src-artifacts: opx-core-artifacts
  - put: aptly
    params:
      aptly_repo: opx-unstable
      publish_prefix: jessie
      publish_dist: unstable
      upload: opx-core-artifacts
  on_failure:
    put: email
    params:
      subject_text: "${BUILD_JOB_NAME} for ${BUILD_PIPELINE_NAME} failed"
      body_text: "((build-url))"

- name: release-stretch
  public: true
  plan:
  - aggregate:
    - get: opx-core
      trigger: true
    - get: concourse
  - task: bump-version
    file: concourse/tasks/debchange-simple/task.yaml
    input_mapping:
      src: opx-core
    output_mapping:
      src-artifacts: opx-core-bumped
  - task: build
    file: concourse/tasks/dpkg-deb-stretch/task.yaml
    input_mapping:
      src: opx-core-bumped
    output_mapping:
      src-artifacts: opx-core-artifacts
  - put: aptly
    params:
      aptly_repo: opx-unstable-stretch
      publish_prefix: stretch
      publish_dist: unstable
      upload: opx-core-artifacts
  on_failure:
    put: email
    params:
      subject_text: "${BUILD_JOB_NAME} for ${BUILD_PIPELINE_NAME} failed"
      body_text: "((build-url))"

## On tag debian/* ##

- name: promote-jessie
  public: true
  plan:
  - aggregate:
    - get: opx-core-tag
      trigger: true
    - get: concourse
  - task: build
    file: concourse/tasks/dpkg-deb-jessie/task.yaml
    input_mapping:
      src: opx-core-tag
    output_mapping:
      src-artifacts: opx-core-artifacts
    params:
      OPX_RELEASE: testing
  - put: aptly
    params:
      aptly_repo: opx-testing
      publish_prefix: jessie
      publish_dist: testing
      upload: opx-core-artifacts
  on_failure:
    put: email
    params:
      subject_text: "${BUILD_JOB_NAME} for ${BUILD_PIPELINE_NAME} failed"
      body_text: "((build-url))"

- name: promote-stretch
  public: true
  plan:
  - aggregate:
    - get: opx-core-tag
      trigger: true
    - get: concourse
  - task: build
    file: concourse/tasks/dpkg-deb-stretch/task.yaml
    input_mapping:
      src: opx-core-tag
    output_mapping:
      src-artifacts: opx-core-artifacts
    params:
      OPX_RELEASE: testing
  - put: aptly
    params:
      aptly_repo: opx-stretch
      publish_prefix: stretch
      publish_dist: testing
      upload: opx-core-artifacts
  on_failure:
    put: email
    params:
      subject_text: "${BUILD_JOB_NAME} for ${BUILD_PIPELINE_NAME} failed"
      body_text: "((build-url))"

## On review ##

- name: check-jessie
  public: true
  plan:
  - aggregate:
    - get: review-opx-core
      trigger: true
      version: every
    - get: concourse
  - task: build
    attempts: 3
    file: concourse/tasks/dpkg-deb-jessie/task.yaml
    input_mapping:
      src: review-opx-core
    on_success:
      put: review-opx-core
      params:
        repository: review-opx-core
        message: "Build ci/${BUILD_TEAM_NAME}/${BUILD_PIPELINE_NAME}/${BUILD_JOB_NAME}/${BUILD_NAME} succeeded!"
        labels: {Verified: 2}
    on_failure:
      put: review-opx-core
      params:
        repository: review-opx-core
        message: "Build ci/${BUILD_TEAM_NAME}/${BUILD_PIPELINE_NAME}/${BUILD_JOB_NAME}/${BUILD_NAME} failed."
        labels: {Verified: -1}

- name: check-stretch
  public: true
  plan:
  - aggregate:
    - get: review-opx-core
      trigger: true
      version: every
    - get: concourse
  - task: build
    attempts: 3
    file: concourse/tasks/dpkg-deb-stretch/task.yaml
    input_mapping:
      src: review-opx-core
    on_success:
      put: review-opx-core
      params:
        repository: review-opx-core
        message: "Build ci/${BUILD_TEAM_NAME}/${BUILD_PIPELINE_NAME}/${BUILD_JOB_NAME}/${BUILD_NAME} succeeded!"
    on_failure:
      put: review-opx-core
      params:
        repository: review-opx-core
        message: "Build ci/${BUILD_TEAM_NAME}/${BUILD_PIPELINE_NAME}/${BUILD_JOB_NAME}/${BUILD_NAME} failed."

- name: pull-request-jessie
  public: true
  plan:
  - aggregate:
    - get: opx-core-pr
      trigger: false
      version: every
    - get: concourse
  - put: opx-core-pr
    params: {path: opx-core-pr, status: pending, context: jessie}
  - task: build
    attempts: 3
    file: concourse/tasks/dpkg-deb-jessie/task.yaml
    input_mapping:
      src: opx-core-pr
    on_success:
      put: opx-core-pr
      params: {path: opx-core-pr, status: success, context: jessie}
    on_failure:
      put: opx-core-pr
      params: {path: opx-core-pr, status: failure, context: jessie}

- name: pull-request-stretch
  public: true
  plan:
  - aggregate:
    - get: opx-core-pr
      trigger: false
      version: every
    - get: concourse
  - put: opx-core-pr
    params: {path: opx-core-pr, status: pending, context: stretch}
  - task: build
    attempts: 3
    file: concourse/tasks/dpkg-deb-stretch/task.yaml
    input_mapping:
      src: opx-core-pr
    on_success:
      put: opx-core-pr
      params: {path: opx-core-pr, status: success, context: stretch}
    on_failure:
      put: opx-core-pr
      params: {path: opx-core-pr, status: failure, context: stretch}
