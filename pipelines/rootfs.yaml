groups: #######################################################################

- name: tag
  jobs:
  - release-jessie
  - release-jessie-docker
  - release-stretch
  - release-stretch-docker

- name: review
  jobs: [pull-request]

resource_types: ###############################################################

- name: pull-request
  type: docker-image
  source:
    repository: jtarchie/pr

resources: ####################################################################

## Source repository ##

- name: rootfs
  type: git
  source:
    uri: https://github.com/open-switch/rootfs
    branch: master
    tag_filter: "[[:digit:]]*.[[:digit:]]*.[[:digit:]]*"

- name: rootfs-pr
  type: pull-request
  source:
    access_token: ((github-pr))
    repo: open-switch/rootfs

## CI configuration ##

- name: concourse
  type: git
  source:
    uri: https://github.com/open-switch/continuous-integration
    branch: master

## Artifacts ##

- name: jessie-rootfs-tarball
  type: s3
  source:
    bucket: archive.openswitch.net
    regexp: "rootfs/opx-rootfs_(.*-jessie)_amd64.tar.gz"
    region_name: us-west-2
    access_key_id: ((aws-s3.access-key))
    secret_access_key: ((aws-s3.secret-key))

- name: stretch-rootfs-tarball
  type: s3
  source:
    bucket: archive.openswitch.net
    regexp: "rootfs/opx-rootfs_(.*-stretch)_amd64.tar.gz"
    region_name: us-west-2
    access_key_id: ((aws-s3.access-key))
    secret_access_key: ((aws-s3.secret-key))

- name: rootfs-image
  type: docker-image
  source:
    repository: opxhub/rootfs
    username: ((docker.username))
    password: ((docker.password))

jobs: #########################################################################

- name: release-jessie
  public: true
  plan:
  - aggregate:
    - get: rootfs
      trigger: true
    - get: concourse
  - task: build
    attempts: 2
    privileged: true
    file: concourse/tasks/rootfs/task.yaml
    params:
      DIST: jessie
  - put: jessie-rootfs-tarball
    params:
      file: rootfs-artifacts/opx-rootfs_*_amd64.tar.gz
      acl: public-read

- name: release-stretch
  public: true
  plan:
  - aggregate:
    - get: rootfs
      trigger: true
    - get: concourse
  - task: build
    attempts: 2
    privileged: true
    file: concourse/tasks/rootfs/task.yaml
    params:
      DIST: stretch
  - put: stretch-rootfs-tarball
    params:
      file: rootfs-artifacts/opx-rootfs_*_amd64.tar.gz
      acl: public-read

- name: release-jessie-docker
  public: true
  plan:
  - aggregate:
    - get: jessie-rootfs-tarball
      trigger: true
      passed: [release-jessie]
    - get: rootfs
      passed: [release-jessie]
    - get: concourse
  - task: rootfs-image-prep
    file: concourse/tasks/rootfs-image-prep/task.yaml
    params:
      DIST: jessie
    input_mapping:
      rootfs-tarball: jessie-rootfs-tarball
  - put: rootfs-image
    params:
      import_file: rootfs-artifacts/rootfs.tar.gz
      tag: rootfs-artifacts/version
      additional_tags: rootfs-artifacts/tags
      tag_as_latest: true

- name: release-stretch-docker
  public: true
  plan:
  - aggregate:
    - get: stretch-rootfs-tarball
      trigger: true
      passed: [release-stretch]
    - get: rootfs
      passed: [release-stretch]
    - get: concourse
  - task: rootfs-image-prep
    file: concourse/tasks/rootfs-image-prep/task.yaml
    params:
      DIST: stretch
    input_mapping:
      rootfs-tarball: stretch-rootfs-tarball
  - put: rootfs-image
    params:
      import_file: rootfs-artifacts/rootfs.tar.gz
      tag: rootfs-artifacts/version
      additional_tags: rootfs-artifacts/tags

- name: pull-request
  public: true
  plan:
  - aggregate:
    - get: rootfs-pr
      trigger: true
      version: every
    - get: concourse
  - aggregate:
    - do:
      - put: rootfs-pr
        params: {path: rootfs-pr, status: pending, context: jessie}
      - task: check-jessie
        attempts: 2
        privileged: true
        file: concourse/tasks/rootfs/task.yaml
        params:
          DIST: jessie
        input_mapping:
          rootfs: rootfs-pr
        on_success:
          put: rootfs-pr
          params: {path: rootfs-pr, status: success, context: jessie}
        on_failure:
          put: rootfs-pr
          params: {path: rootfs-pr, status: failure, context: jessie}
    - do:
      - put: rootfs-pr
        params: {path: rootfs-pr, status: pending, context: stretch}
      - task: check-stretch
        attempts: 2
        privileged: true
        file: concourse/tasks/rootfs/task.yaml
        params:
          DIST: stretch
        input_mapping:
          rootfs: rootfs-pr
        on_success:
          put: rootfs-pr
          params: {path: rootfs-pr, status: success, context: stretch}
        on_failure:
          put: rootfs-pr
          params: {path: rootfs-pr, status: failure, context: stretch}
