groups: #######################################################################

- name: commit
  jobs: [release-jessie, release-stretch]

- name: tag
  jobs: [promote-jessie, promote-stretch]

resource_types: ###############################################################

- name: aptly-resource
  type: docker-image
  source:
    repository: opxhub/aptly-resource

- name: email
  type: docker-image
  source:
    repository: pcfseceng/email-resource

resources: ####################################################################

## Source repositories ##

- name: sai
  type: git
  source:
    uri: https://github.com/open-switch/sai
    branch: dell.1.2+

- name: sai-tag
  type: git
  source:
    uri: https://github.com/open-switch/sai
    branch: dell.1.2+
    tag_filter: "debian/*"

## CI configuration ##

- name: concourse
  type: git
  source:
    uri: https://github.com/open-switch/continuous-integration
    branch: master

- name: aptly
  type: aptly-resource
  source:
    api: http://aptly:8080/api

- name: email
  type: email
  source:
    smtp:
      host: email-smtp.us-west-2.amazonaws.com
      port: "587"
      username: ((smtp.username))
      password: ((smtp.password))
    from: opx@openswitch.net
    to:
    -  tyler.heucke@dell.com

jobs: #########################################################################

## On commit ##

- name: release-jessie
  public: true
  plan:
  - aggregate:
    - get: sai
      trigger: true
    - get: concourse
  - task: bump-version
    file: concourse/tasks/debchange-git/task.yaml
    input_mapping:
      src: sai
    output_mapping:
      src-artifacts: sai-bumped
  - task: build
    privileged: true
    file: concourse/tasks/git-buildpackage-jessie/task.yaml
    input_mapping:
      src: sai-bumped
    output_mapping:
      src-artifacts: sai-artifacts
  - put: aptly
    params:
      aptly_repo: opx-unstable
      publish_prefix: jessie
      publish_dist: unstable
      upload: sai-artifacts
  on_failure:
    put: email
    params:
      subject_text: "${BUILD_JOB_NAME} for ${BUILD_PIPELINE_NAME} failed"
      body_text: "((build-url))"

- name: release-stretch
  public: true
  plan:
  - aggregate:
    - get: sai
      trigger: true
    - get: concourse
  - task: bump-version
    file: concourse/tasks/debchange-git/task.yaml
    input_mapping:
      src: sai
    output_mapping:
      src-artifacts: sai-bumped
  - task: build
    privileged: true
    file: concourse/tasks/git-buildpackage-stretch/task.yaml
    input_mapping:
      src: sai-bumped
    output_mapping:
      src-artifacts: sai-artifacts
  - put: aptly
    params:
      aptly_repo: opx-unstable-stretch
      publish_prefix: stretch
      publish_dist: unstable
      upload: sai-artifacts
  on_failure:
    put: email
    params:
      subject_text: "${BUILD_JOB_NAME} for ${BUILD_PIPELINE_NAME} failed"
      body_text: "((build-url))"

## On tag debian/* ##

- name: promote-jessie
  public: true
  plan:
  - aggregate:
    - get: sai-tag
      trigger: true
    - get: concourse
  - task: build
    privileged: true
    file: concourse/tasks/git-buildpackage-jessie/task.yaml
    input_mapping:
      src: sai-tag
    output_mapping:
      src-artifacts: sai-artifacts
    params:
      OPX_RELEASE: testing
  - put: aptly
    params:
      aptly_repo: opx-testing
      publish_prefix: jessie
      publish_dist: testing
      upload: sai-artifacts
  on_failure:
    put: email
    params:
      subject_text: "${BUILD_JOB_NAME} for ${BUILD_PIPELINE_NAME} failed"
      body_text: "((build-url))"

- name: promote-stretch
  public: true
  plan:
  - aggregate:
    - get: sai-tag
      trigger: true
    - get: concourse
  - task: build
    privileged: true
    file: concourse/tasks/git-buildpackage-stretch/task.yaml
    input_mapping:
      src: sai-tag
    output_mapping:
      src-artifacts: sai-artifacts
    params:
      OPX_RELEASE: testing
  - put: aptly
    params:
      aptly_repo: opx-stretch
      publish_prefix: stretch
      publish_dist: testing
      upload: sai-artifacts
  on_failure:
    put: email
    params:
      subject_text: "${BUILD_JOB_NAME} for ${BUILD_PIPELINE_NAME} failed"
      body_text: "((build-url))"
